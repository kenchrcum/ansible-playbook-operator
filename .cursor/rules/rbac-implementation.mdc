---
globs: "helm/**/*.yaml,examples/**/*.yaml"
description: "RBAC implementation patterns and security principles for the operator."
---
# RBAC Implementation Patterns

## Preset Structure
Implement RBAC with three progressive levels controlled by `rbac.preset` Helm value:

### Minimal (Default)
- Namespaced Role with core operator permissions only
- Read-only access to referenced Secrets
- Basic cluster read permissions for CRDs/namespaces (when enabled)
- **Use case**: Single-namespace deployments with minimal trust

### Scoped
- Extended namespaced permissions for cross-namespace scenarios
- ClusterRole for reading resources across namespaces
- **Use case**: Multi-namespace operator deployments

### Cluster-Admin
- Full cluster permissions within namespace
- Separate ClusterRole with wildcard permissions
- **Use case**: Playbooks requiring cluster-wide resource management

## Implementation Template Pattern
```yaml
# Role template with conditional rules
rules:
{{- if eq .Values.rbac.preset "cluster-admin" }}
  # Full permissions
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["*"]
{{- else if eq .Values.rbac.preset "scoped" }}
  # Extended permissions
  - apiGroups: ["extended-groups"]
    resources: ["extended-resources"]
    verbs: ["read", "list", "watch", "create"]
{{- else }}
  # Minimal permissions (default)
  - apiGroups: ["core-groups"]
    resources: ["core-resources"]
    verbs: ["read", "list", "watch"]
{{- end }}
```

## Security Principles
- **Default to minimal**: Always set `minimal` as the default preset
- **Progressive escalation**: Each preset builds on the previous level
- **Clear documentation**: Document risks and use cases for each preset
- **Backward compatibility**: Maintain existing boolean flags alongside presets
- **Principle of least privilege**: Only grant permissions actually needed

## Common Permission Patterns
- **Operator core**: `jobs`, `cronjobs`, `pods/log`, `events` (read + manage)
- **Custom resources**: Full CRUD on owned CRDs (`repositories`, `playbooks`, `schedules`)
- **Referenced secrets**: Read-only access to secrets specified in CR specs
- **Cluster discovery**: Read CRDs and namespaces for preflight checks

## Validation Checklist
- [ ] Minimal preset provides least-privilege for single-namespace operation
- [ ] Scoped preset enables cross-namespace scenarios without full cluster access
- [ ] Cluster-admin preset is clearly marked as high-risk with warnings
- [ ] Backward compatibility maintained with existing configurations
- [ ] Documentation includes preset trade-offs and use cases
